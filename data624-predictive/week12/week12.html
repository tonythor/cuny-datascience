<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="By Tony Fraser">
<meta name="dcterms.date" content="2024-04-14">

<title>Week 12 Trees and Rules</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="week12_files/libs/clipboard/clipboard.min.js"></script>
<script src="week12_files/libs/quarto-html/quarto.js"></script>
<script src="week12_files/libs/quarto-html/popper.min.js"></script>
<script src="week12_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="week12_files/libs/quarto-html/anchor.min.js"></script>
<link href="week12_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="week12_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="week12_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="week12_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="week12_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="week12_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="week12_files/libs/viz-1.8.2/viz.js"></script>
<link href="week12_files/libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="week12_files/libs/grViz-binding-1.0.11/grViz.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#simulated-data-from-chapter-7" id="toc-simulated-data-from-chapter-7" class="nav-link active" data-scroll-target="#simulated-data-from-chapter-7">8.1 Simulated Data from Chapter 7</a>
  <ul class="collapse">
  <li><a href="#fit-and-estimate" id="toc-fit-and-estimate" class="nav-link" data-scroll-target="#fit-and-estimate">Fit and Estimate</a></li>
  <li><a href="#add-an-additional-predictor" id="toc-add-an-additional-predictor" class="nav-link" data-scroll-target="#add-an-additional-predictor">Add an Additional Predictor</a></li>
  <li><a href="#conditional-inference-trees" id="toc-conditional-inference-trees" class="nav-link" data-scroll-target="#conditional-inference-trees">Conditional Inference Trees</a></li>
  <li><a href="#use-boosted-and-cubist" id="toc-use-boosted-and-cubist" class="nav-link" data-scroll-target="#use-boosted-and-cubist">Use Boosted and Cubist</a></li>
  </ul></li>
  <li><a href="#tree-granularity-bias" id="toc-tree-granularity-bias" class="nav-link" data-scroll-target="#tree-granularity-bias">8.2 Tree Granularity Bias</a></li>
  <li><a href="#gradient-boosting" id="toc-gradient-boosting" class="nav-link" data-scroll-target="#gradient-boosting">8.3 Gradient Boosting</a></li>
  <li><a href="#more-on-chemical-manufacturing" id="toc-more-on-chemical-manufacturing" class="nav-link" data-scroll-target="#more-on-chemical-manufacturing">8.7 More On Chemical Manufacturing</a>
  <ul class="collapse">
  <li><a href="#and-the-winner-is" id="toc-and-the-winner-is" class="nav-link" data-scroll-target="#and-the-winner-is">And the winner is</a></li>
  <li><a href="#predictors" id="toc-predictors" class="nav-link" data-scroll-target="#predictors">Predictors</a></li>
  <li><a href="#tree-plots" id="toc-tree-plots" class="nav-link" data-scroll-target="#tree-plots">Tree Plots</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 12 Trees and Rules</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>By Tony Fraser </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 14, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)  </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(party) </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pls)  </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pdp) </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Cubist)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen=</span><span class="dv">999</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(earth)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Formula)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotmo)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotrix)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(AppliedPredictiveModeling)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ChemicalManufacturingProcess)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="simulated-data-from-chapter-7" class="level1">
<h1>8.1 Simulated Data from Chapter 7</h1>
<p>8.1. Recreate the simulated data from Exercise 7.2:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlbench)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">200</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>simulated <span class="ot">&lt;-</span> <span class="fu">mlbench.friedman1</span>(<span class="dv">200</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>simulated <span class="ot">&lt;-</span> <span class="fu">cbind</span>(simulated<span class="sc">$</span>x, simulated<span class="sc">$</span>y)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>simulated <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(simulated)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(simulated)[<span class="fu">ncol</span>(simulated)] <span class="ot">&lt;-</span> <span class="st">"y"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fit-and-estimate" class="level3">
<h3 class="anchored" data-anchor-id="fit-and-estimate">Fit and Estimate</h3>
<p><em>Fit a random forest model to all of the predictors, then estimate the variable importance scores. Did the random forest model significantly use the uninformative predictors (V6 – V10)?</em></p>
<p>No, quite the opposite. V1, V2 and V4 are the important predictors. V6, V7, V8, V9, and V10 contribute very little when predicting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(y <span class="sc">~</span> ., <span class="at">data =</span> simulated,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">importance =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">ntree =</span> <span class="dv">1000</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>rfImp1 <span class="ot">&lt;-</span> <span class="fu">varImp</span>(model1, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rfImp1) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Overall
V1   8.608151977
V2   6.427551579
V3   0.793562571
V4   7.872625387
V5   2.399842693
V6   0.008598025
V7   0.037203805
V8  -0.071849590
V9  -0.053688259
V10  0.025364287</code></pre>
</div>
</div>
</section>
<section id="add-an-additional-predictor" class="level3">
<h3 class="anchored" data-anchor-id="add-an-additional-predictor">Add an Additional Predictor</h3>
<p><em>Now add an additional predictor that is highly correlated with one of the informative predictors. For example: Fit another random forest model to these data. Did the importance score for V1 change? What happens when you add another predictor that is also highly correlated with V1?</em></p>
<p>It definitely splits the difference between V1 and the new predictor. Beyond that, the rest of the variables are pretty close to what they were before. I suppose that’s why they say random forest can handle collinear data better than other models can.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>simulated<span class="sc">$</span>duplicate1 <span class="ot">&lt;-</span> simulated<span class="sc">$</span>V1 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">200</span>) <span class="sc">*</span> .<span class="dv">1</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(simulated<span class="sc">$</span>duplicate1, simulated<span class="sc">$</span>V1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9419944</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(y <span class="sc">~</span> ., <span class="at">data =</span> simulated,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">importance =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">ntree =</span> <span class="dv">1000</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>rfImp2 <span class="ot">&lt;-</span> <span class="fu">varImp</span>(model2, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rfImp2) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Overall
V1          6.24433281
V2          6.55448083
V3          0.61121432
V4          6.87146935
V5          1.97671729
V6          0.14715800
V7          0.02442013
V8         -0.09719199
V9         -0.12151768
V10        -0.07987999
duplicate1  3.34727743</code></pre>
</div>
</div>
</section>
<section id="conditional-inference-trees" class="level3">
<h3 class="anchored" data-anchor-id="conditional-inference-trees">Conditional Inference Trees</h3>
<p><em>Use the cforest function in the party package to fit a random forest model using conditional inference trees. The party package function varimp can calculate predictor importance. The conditional argument of that function toggles between the traditional importance measure and the modified version described in Strobl et al.&nbsp;(2007). Do these importances show the same pattern as the traditional random forest model?</em></p>
<p>Here’s what I found about this test.</p>
<ol type="1">
<li>Using a simmple one Mississippi two Mississippi count, I found conditional=TRUE to take about 25X longer that conditional=FALSE</li>
<li>the two collinear variables V1 and duplicate1 are very much deprioritized..</li>
<li>Besides those colinear variables, the relative importance seems somewhat similar.</li>
</ol>
<div class="cell" data-messages="false">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">cforest</span>(y <span class="sc">~</span> ., <span class="at">data =</span> simulated, <span class="at">controls=</span><span class="fu">cforest_unbiased</span>(<span class="at">ntree=</span><span class="dv">1000</span>, <span class="at">mtry=</span><span class="dv">2</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>rfImp3False <span class="ot">&lt;-</span> <span class="fu">varimp</span>(model3, <span class="at">conditional=</span><span class="cn">FALSE</span>) </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>rfImp3False_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Overall =</span> rfImp3False)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(rfImp3False_df) <span class="ot">&lt;-</span> <span class="fu">names</span>(rfImp3False)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>rfImp3True <span class="ot">&lt;-</span> <span class="fu">varimp</span>(model3, <span class="at">conditional=</span><span class="cn">TRUE</span>) </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>rfImp3True_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Overall =</span> rfImp3True)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(rfImp3True_df) <span class="ot">&lt;-</span> <span class="fu">names</span>(rfImp3True)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rfImp3False_df)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rfImp3True_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-boosted-and-cubist" class="level3">
<h3 class="anchored" data-anchor-id="use-boosted-and-cubist">Use Boosted and Cubist</h3>
<p><em>Repeat this process with different tree models, such as boosted trees and Cubist. Does the same pattern occur? (refer to figure 8.24)</em></p>
<p>For both, yes, it’s about the same. V1, V2, V4, V5 and duplicate1 are the more used features.</p>
<div class="cell" data-messages="false">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> simulated[, <span class="sc">!</span><span class="fu">names</span>(simulated) <span class="sc">%in%</span> <span class="st">"y"</span>]  <span class="co"># This excludes 'y' by name</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>modelCubist <span class="ot">&lt;-</span> <span class="fu">cubist</span>(<span class="at">x =</span> predictors, <span class="at">y =</span> simulated<span class="sc">$</span>y, <span class="at">committees =</span> <span class="dv">1</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>data_matrix <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">as.matrix</span>(simulated[, <span class="sc">!</span><span class="fu">names</span>(simulated) <span class="sc">%in%</span> <span class="st">"y"</span>]),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> simulated<span class="sc">$</span>y</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>modelXGBoost <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">data =</span> data_matrix, </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.depth =</span> <span class="dv">6</span>, <span class="at">eta =</span> <span class="fl">0.3</span>, <span class="at">nthread =</span> <span class="dv">2</span>, </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">nrounds =</span> <span class="dv">100</span>, <span class="at">objective =</span> <span class="st">"reg:squarederror"</span>, <span class="at">verbose=</span><span class="dv">0</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>importance_matrix <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_names =</span> <span class="fu">colnames</span>(simulated[, <span class="sc">!</span><span class="fu">names</span>(simulated) <span class="sc">%in%</span> <span class="st">"y"</span>]), <span class="at">model =</span> modelXGBoost)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelCubist) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
cubist.default(x = predictors, y = simulated$y, committees = 1)


Cubist [Release 2.07 GPL Edition]  Sat Apr 13 22:19:25 2024
---------------------------------

    Target attribute `outcome'

Read 200 cases (12 attributes) from undefined.data

Model:

  Rule 1: [200 cases, mean 14.416183, range 3.55596 to 28.38167, est err 1.944664]

    outcome = 0.183529 + 8.9 V4 + 7.9 V1 + 7.1 V2 + 5.3 V5


Evaluation on training data (200 cases):

    Average  |error|           2.151842
    Relative |error|               0.53
    Correlation coefficient        0.85


    Attribute usage:
      Conds  Model

             100%    V1
             100%    V2
             100%    V4
             100%    V5


Time: 0.0 secs</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(importance_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Feature        Gain      Cover  Frequency
        &lt;char&gt;       &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
 1:         V1 0.318668826 0.07037823 0.15933782
 2:         V2 0.281275067 0.09495117 0.11536472
 3:         V4 0.242506748 0.10370234 0.10501811
 4:         V5 0.061052342 0.11306834 0.08949819
 5:         V3 0.030721950 0.13482329 0.09518883
 6: duplicate1 0.028559596 0.07112628 0.06828764
 7:         V7 0.017198188 0.10078187 0.08639421
 8:        V10 0.007285918 0.06322563 0.05897569
 9:         V6 0.006436033 0.07435417 0.07656492
10:         V9 0.003896760 0.06137088 0.06621831
11:         V8 0.002398572 0.11221782 0.07915158</code></pre>
</div>
</div>
</section>
</section>
<section id="tree-granularity-bias" class="level1">
<h1>8.2 Tree Granularity Bias</h1>
<p><em>Use a simulation to show tree bias with different granularity.</em></p>
<p>I had difficult time coming up with this until I heard an exmaple that made sense to me. And I’d like to keep this example here in my notes so I can find it later.</p>
<p>Imagine you are trying to decide where to plant different types of plants in a garden based on sunlight and soil type</p>
<ul>
<li>Soil type: You have a map that categorizes soil into different types based on its nutrients (granularity varies).</li>
<li>Sunlight: Varies continuously throughout the garden.</li>
</ul>
<p>If your map (granularity of X1) is very detailed, you might focus a lot on tiny differences in soil nutrients and miss broader patterns of sunlight (X2). Conversely, if the soil map is very basic, you might pay more attention to sunlight variations. This is analogous to how decision trees might develop biases based on the characteristics of the data they receive.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>show_tree <span class="ot">&lt;-</span> <span class="cf">function</span>(observations, granularity) {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Var 1 - different levesl of granularity. If granularity is 10, X1 will have values like 0, 0.1, 0.2, up to 0.9. If granularity is 100, X1 will have values like 0, 0.01, 0.02, up to 0.99, making it much more detailed.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  soil_type <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">runif</span>(observations, <span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">*</span> granularity) <span class="sc">/</span> granularity</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Var 2, normal distribution data.</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  sunlight <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(observations)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> soil_type <span class="sc">+</span> sunlight <span class="sc">+</span> <span class="fu">rnorm</span>(observations, <span class="at">sd=</span><span class="fl">0.5</span>) <span class="sc">&gt;</span> <span class="fl">1.5</span>  <span class="co"># Binary outcome</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit a decision tree, Y = true or false</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(soil_type, sunlight, Y)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y <span class="sc">~</span> soil_type <span class="sc">+</span> sunlight, <span class="at">data=</span>data, <span class="at">method=</span><span class="st">"class"</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the tree</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(model)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(model, <span class="at">use.n=</span><span class="cn">TRUE</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="fu">show_tree</span>(<span class="dv">200</span>, <span class="dv">10</span>) <span class="co"># low granularity</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="week12_files/figure-html/decisionTree-1.png" class="img-fluid" width="864"></p>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_tree</span>(<span class="dv">200</span>, <span class="dv">100</span>) <span class="co"># high granularity</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="week12_files/figure-html/decisionTree-2.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>To explain that, the top tree has a single split. The soil_type variable, which has low granularity, is not used at all. The absence of splits on soil_type could suggest a bias towards the more continuous variable (sunlight), as it didn’t find soil_type informative enough due to its coarse categories.</p>
<p>The bottom chart splits on both soil type and sunlight, indicating that the higher granularity of soil_type provided more informative splits. After the initial split, we see splits based on soil_type at soil_type &lt; 0.675 and soil_type &lt; 0.375. These splits are evidence that with more granularity, the soil_type variable becomes informative enough to be used for making decisions. The tree now shows a bias towards using soil_type alongside sunlight, demonstrating that when provided with more detailed categories, the decision tree incorporates soil_type into its model.</p>
</section>
<section id="gradient-boosting" class="level1">
<h1>8.3 Gradient Boosting</h1>
<p><em>In stochastic gradient boosting, the bagging fraction and learning rate will govern the construction of the trees as they are guided by the gradient. Although the optimal values of these parameters should be obtained through the tuning process, it is helpful to understand how the magnitudes of these parameters affect magnitudes of variable importance. Figure 8.24 provides the variable importance plots for boosting using two extreme values for the bagging fraction (0.1 and 0.9) and the learning rate (0.1 and 0.9) for the solubility data. The left-hand plot has both parameters set to 0.1, and the right-hand plot has both set to 0.9</em></p>
<p><em>Why does the model on the right focus its importance on just the first few of predictors, whereas the model on the left spreads importance across more predictors?</em></p>
<p>This has to do with the bagging fraction. The left has a lower fraction, which means the left was trained on a smaller subset of data. Therefore, it must consider a broad range of predictors to make accurate predictions across the datasets. The one on the right, the algorithm sees mots of the data, which means the model can more reliably find teh right predictors.</p>
<p>After having gone through all this, I only wonder which model is more accurate. I suppose this is another lever we have at our disposal.</p>
<p><em>Which model do you think would be more predictive of other samples?</em></p>
<p>According to what I read, the one on the left. It spreads learning across more predictors to learn slowly. The one on the right is a little more fit just to that specific dataset.</p>
<p><em>How would increasing interaction depth affect the slope of predictor importance for either model in Fig. 8.24?</em></p>
<p>I think it would impact the one on the left. The one on the right with that .9 is pretty much overfit to that data and not leveraging most of the other features. The column on the left has more room to be impacted.</p>
</section>
<section id="more-on-chemical-manufacturing" class="level1">
<h1>8.7 More On Chemical Manufacturing</h1>
<p><em>Refer to Exercises 6.3 and 7.5 which describe a chemical manufacturing process. Use the same data imputation, data splitting, and pre-processing steps as before and train several tree-based models</em></p>
<p>I’ll pull in the last several, and I’ll add in XGBoost.</p>
<div class="cell" data-messages="false">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="ot">&lt;-</span> <span class="fu">preProcess</span>(ChemicalManufacturingProcess, <span class="at">method=</span><span class="st">'medianImpute'</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>processed_data <span class="ot">&lt;-</span> <span class="fu">predict</span>(imputed_data, ChemicalManufacturingProcess)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>splitIndex <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(processed_data<span class="sc">$</span>Yield, <span class="at">p =</span> <span class="fl">0.80</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> processed_data[splitIndex, ]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> processed_data[<span class="sc">-</span>splitIndex, ]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># KNN</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>knnModel <span class="ot">&lt;-</span> <span class="fu">train</span>(Yield <span class="sc">~</span> ., <span class="at">data =</span> train_data,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"knn"</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"scale"</span>),</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tuneLength =</span> <span class="dv">5</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>knnPred <span class="ot">&lt;-</span> <span class="fu">predict</span>(knnModel, <span class="at">newdata =</span> test_data)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>knnMetrics <span class="ot">&lt;-</span> <span class="fu">postResample</span>(<span class="at">pred =</span> knnPred, <span class="at">obs =</span> test_data<span class="sc">$</span>Yield)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># MARS</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>marsModel <span class="ot">&lt;-</span> <span class="fu">train</span>(Yield <span class="sc">~</span> ., <span class="at">data =</span> train_data,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">"earth"</span>,</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"scale"</span>),</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tuneLength =</span> <span class="dv">5</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>marsPred <span class="ot">&lt;-</span> <span class="fu">predict</span>(marsModel, <span class="at">newdata =</span> test_data)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>marsMetrics <span class="ot">&lt;-</span> <span class="fu">postResample</span>(<span class="at">pred =</span> marsPred, <span class="at">obs =</span> test_data<span class="sc">$</span>Yield)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co"># SVM</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>svmModel <span class="ot">&lt;-</span> <span class="fu">train</span>(Yield <span class="sc">~</span> ., <span class="at">data =</span> train_data,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"svmRadial"</span>,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"scale"</span>),</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tuneLength =</span> <span class="dv">5</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>svmPred <span class="ot">&lt;-</span> <span class="fu">predict</span>(svmModel, <span class="at">newdata =</span> test_data)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>svmMetrics <span class="ot">&lt;-</span> <span class="fu">postResample</span>(<span class="at">pred =</span> svmPred, <span class="at">obs =</span> test_data<span class="sc">$</span>Yield)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Random Forest</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>rfModel <span class="ot">&lt;-</span> <span class="fu">train</span>(Yield <span class="sc">~</span> ., <span class="at">data =</span> train_data,</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">"rf"</span>,</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>                 <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"scale"</span>),</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                 <span class="at">tuneLength =</span> <span class="dv">5</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>rfPred <span class="ot">&lt;-</span> <span class="fu">predict</span>(rfModel, <span class="at">newdata =</span> test_data)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>rfMetrics <span class="ot">&lt;-</span> <span class="fu">postResample</span>(<span class="at">pred =</span> rfPred, <span class="at">obs =</span> test_data<span class="sc">$</span>Yield)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Isn't working through caret, will use directly.</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">booster =</span> <span class="st">"gbtree"</span>,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">objective =</span> <span class="st">"reg:squarederror"</span>,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fl">0.3</span>,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="dv">6</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>dtrain <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(train_data[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(train_data) <span class="sc">==</span> <span class="st">"Yield"</span>)]), </span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>                      <span class="at">label =</span> train_data<span class="sc">$</span>Yield)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>xgbModel <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(<span class="at">params =</span> params, <span class="at">data =</span> dtrain, <span class="at">nrounds =</span> <span class="dv">100</span>)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>xgbPred <span class="ot">&lt;-</span> <span class="fu">predict</span>(xgbModel, <span class="fu">as.matrix</span>(test_data[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(test_data) <span class="sc">==</span> <span class="st">"Yield"</span>)]))</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>xgbMetrics <span class="ot">&lt;-</span> <span class="fu">postResample</span>(<span class="at">pred =</span> xgbPred, <span class="at">obs =</span> test_data<span class="sc">$</span>Yield)</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine model performance metrics</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>modelPerformance <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(knnMetrics[<span class="dv">1</span>], marsMetrics[<span class="dv">1</span>],  svmMetrics[<span class="dv">1</span>], rfMetrics[<span class="dv">1</span>], xgbMetrics[<span class="dv">1</span>]),</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">Rsquared =</span> <span class="fu">c</span>(knnMetrics[<span class="dv">2</span>], marsMetrics[<span class="dv">2</span>],  svmMetrics[<span class="dv">2</span>], rfMetrics[<span class="dv">2</span>], xgbMetrics[<span class="dv">2</span>]),</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE =</span> <span class="fu">c</span>(knnMetrics[<span class="dv">3</span>], marsMetrics[<span class="dv">3</span>],  svmMetrics[<span class="dv">3</span>], rfMetrics[<span class="dv">3</span>],  xgbMetrics[<span class="dv">3</span>]),</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="fu">c</span>(<span class="st">"KNN"</span>, <span class="st">"MARS"</span>, <span class="st">"SVM"</span>, <span class="st">"RF"</span>, <span class="st">"XGBoost"</span>)</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>modelPerformance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            RMSE  Rsquared       MAE
KNN     1.406333 0.4224466 1.1606875
MARS    1.402311 0.4244340 1.1104190
SVM     1.228647 0.5562600 1.0257624
RF      1.274071 0.5347547 0.9730071
XGBoost 1.028613 0.6809667 0.7879700</code></pre>
</div>
</div>
<section id="and-the-winner-is" class="level3">
<h3 class="anchored" data-anchor-id="and-the-winner-is">And the winner is</h3>
<p><em>Which tree-based regression model gives the optimal resampling and test set performance?</em></p>
<p>Wow, XGBoost with the big win!</p>
</section>
<section id="predictors" class="level3">
<h3 class="anchored" data-anchor-id="predictors">Predictors</h3>
<p><em>Which predictors are most important in the optimal tree-based regression model? Do either the biological or process variables dominate the list? How do the top 10 important predictors compare to the top 10 predictors from the optimal linear and nonlinear models?</em></p>
<p>The variables are mostly the same, but the order is slightly different. You can see there are little differences between which model puts weight on which features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#XGBoost</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>importance_matrix <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(<span class="at">feature_names =</span> <span class="fu">colnames</span>(dtrain)[<span class="sc">!</span><span class="fu">colnames</span>(dtrain) <span class="sc">%in%</span> <span class="st">"Yield"</span>], <span class="at">model =</span> xgbModel)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>sorted_importance_matrix <span class="ot">&lt;-</span> importance_matrix[<span class="fu">order</span>(<span class="sc">-</span>importance_matrix<span class="sc">$</span>Gain),]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>important_features <span class="ot">&lt;-</span> <span class="fu">head</span>(sorted_importance_matrix, <span class="dv">10</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(important_features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   Feature       Gain       Cover  Frequency
                    &lt;char&gt;      &lt;num&gt;       &lt;num&gt;      &lt;num&gt;
 1: ManufacturingProcess32 0.13697775 0.022868585 0.01449275
 2:   BiologicalMaterial03 0.10386130 0.027716303 0.01630435
 3: ManufacturingProcess31 0.09515613 0.006512804 0.00634058
 4: ManufacturingProcess17 0.09349432 0.021245653 0.01539855
 5: ManufacturingProcess13 0.07765902 0.023711666 0.01811594
 6:   BiologicalMaterial09 0.05815033 0.040805143 0.02898551
 7:   BiologicalMaterial12 0.04474019 0.018041943 0.01086957
 8:   BiologicalMaterial02 0.04312171 0.130677627 0.07065217
 9: ManufacturingProcess43 0.03886919 0.015554853 0.02536232
10: ManufacturingProcess22 0.02905526 0.029149542 0.02355072</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImp</span>(rfModel)<span class="sc">$</span>importance <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(Overall)) <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          Overall
ManufacturingProcess32 100.000000
BiologicalMaterial06    23.393929
ManufacturingProcess31  22.215862
BiologicalMaterial03    17.390282
ManufacturingProcess17  16.059163
ManufacturingProcess36  12.152575
ManufacturingProcess13  11.846488
BiologicalMaterial12    11.272931
ManufacturingProcess09  10.606859
BiologicalMaterial11     9.391015</code></pre>
</div>
</div>
</section>
<section id="tree-plots" class="level3">
<h3 class="anchored" data-anchor-id="tree-plots">Tree Plots</h3>
<p><em>Plot the optimal single tree with the distribution of yield in the terminal nodes. Does this view of the data provide additional knowledge about the biological or process predictors and their relationship with yield?</em></p>
<p>There are two bits of information that stand out. Firstly, there are only two root nodes that start with <strong>ManufacturingProcess32</strong>. One uses just that as a decision, the second uses several variables. I figured there would have been a lot more trees with that root as the root node.</p>
<p>Second, <strong>BiologicalMaterial03</strong> and <strong>ManufacturingProcess31</strong> which are the second and third highest gain variables don’t seem to be in that second tree MFP32 root node tree at all. This learning model learns from itself after multiple tries, but I thought it would be there.</p>
<p>The exact behavior of how this model works is still a little confusing, so added support for Node 0, 1, and 2. And with the same results, those other important features are still not listed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>trees_data <span class="ot">&lt;-</span> <span class="fu">xgb.model.dt.tree</span>(<span class="at">feature_names =</span> <span class="fu">colnames</span>(dtrain), <span class="at">model =</span> xgbModel)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>trees_with_ManufacturingProcess32 <span class="ot">&lt;-</span> <span class="fu">unique</span>(trees_data[Feature <span class="sc">==</span> <span class="st">'ManufacturingProcess32'</span> <span class="sc">&amp;</span>  (Node <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> Node <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span>Node <span class="sc">==</span> <span class="dv">2</span>), <span class="st">"Tree"</span>])</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>tree_numbers <span class="ot">&lt;-</span> trees_with_ManufacturingProcess32<span class="sc">$</span>Tree</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.tree</span>(<span class="at">model =</span> xgbModel, <span class="at">trees =</span> tree_numbers)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-524c4c5c6bf7711fb107" style="width:100%;height:650px;"></div>
<script type="application/json" data-for="htmlwidget-524c4c5c6bf7711fb107">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       rankdir = \"LR\"]\n\nnode [color = \"DimGray\",\n      style = \"filled\",\n      fontname = \"Helvetica\"]\n\nedge [color = \"DimGray\",\n     arrowsize = \"1.5\",\n     arrowhead = \"vee\",\n     fontname = \"Helvetica\"]\n\n  \"1\" [label = \"Tree 8\nManufacturingProcess17\nCover: 144\nGain: 16.3713989\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"2\" [label = \"BiologicalMaterial12\nCover: 40\nGain: 12.7855225\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"3\" [label = \"ManufacturingProcess32\nCover: 104\nGain: 6.52233887\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"4\" [label = \"BiologicalMaterial01\nCover: 27\nGain: 4.11412048\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"5\" [label = \"Leaf\nCover: 13\nValue: 1.18908513\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"6\" [label = \"BiologicalMaterial12\nCover: 61\nGain: 0.221420288\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"7\" [label = \"ManufacturingProcess03\nCover: 43\nGain: 1.83950806\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"8\" [label = \"BiologicalMaterial01\nCover: 19\nGain: 1.35528564\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"9\" [label = \"Leaf\nCover: 8\nValue: 0.445811719\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"10\" [label = \"ManufacturingProcess15\nCover: 60\nGain: 0.167190552\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"11\" [label = \"Leaf\nCover: 1\nValue: 0.151611909\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"12\" [label = \"Leaf\nCover: 8\nValue: 0.484717458\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"13\" [label = \"BiologicalMaterial02\nCover: 35\nGain: 0.7449646\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"14\" [label = \"Leaf\nCover: 2\nValue: 0.316099554\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"15\" [label = \"ManufacturingProcess19\nCover: 17\nGain: 1.30073547\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"16\" [label = \"Leaf\nCover: 2\nValue: 0.231475845\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"17\" [label = \"ManufacturingProcess01\nCover: 58\nGain: 0.154785156\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"18\" [label = \"Leaf\nCover: 2\nValue: 0.319450378\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"19\" [label = \"ManufacturingProcess39\nCover: 33\nGain: 0.754302979\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"20\" [label = \"Leaf\nCover: 16\nValue: 0.888721108\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"21\" [label = \"Leaf\nCover: 1\nValue: 0.210853964\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"22\" [label = \"BiologicalMaterial06\nCover: 26\nGain: 1.39482117\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"23\" [label = \"ManufacturingProcess09\nCover: 32\nGain: 0.853164673\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"24\" [label = \"Leaf\nCover: 28\nValue: 0.862427592\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"25\" [label = \"Leaf\nCover: 5\nValue: 0.481352061\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"26\" [label = \"Leaf\nCover: 2\nValue: 0.224617779\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"27\" [label = \"Leaf\nCover: 24\nValue: 0.666555941\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"28\" [label = \"Leaf\nCover: 12\nValue: 0.356200546\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"29\" [label = \"Leaf\nCover: 20\nValue: 0.553379774\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"30\" [label = \"Tree 7\nManufacturingProcess32\nCover: 144\nGain: 22.394043\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"31\" [label = \"ManufacturingProcess17\nCover: 101\nGain: 12.0391846\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"32\" [label = \"ManufacturingProcess22\nCover: 43\nGain: 9.70666504\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"33\" [label = \"ManufacturingProcess45\nCover: 33\nGain: 4.54525757\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"34\" [label = \"ManufacturingProcess34\nCover: 68\nGain: 0.348602295\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"35\" [label = \"ManufacturingProcess06\nCover: 37\nGain: 5.49755859\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"36\" [label = \"Leaf\nCover: 6\nValue: 0.665761828\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"37\" [label = \"Leaf\nCover: 8\nValue: 0.703231335\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"38\" [label = \"ManufacturingProcess43\nCover: 25\nGain: 3.46109009\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"39\" [label = \"Leaf\nCover: 1\nValue: 0.223226741\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"40\" [label = \"BiologicalMaterial09\nCover: 67\nGain: 0.250579834\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"41\" [label = \"Leaf\nCover: 4\nValue: 0.6524176\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"42\" [label = \"BiologicalMaterial02\nCover: 33\nGain: 1.43914795\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"43\" [label = \"Leaf\nCover: 3\nValue: 0.547749996\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"44\" [label = \"ManufacturingProcess09\nCover: 22\nGain: 1.02828979\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"45\" [label = \"Leaf\nCover: 2\nValue: 0.336838543\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"46\" [label = \"BiologicalMaterial04\nCover: 65\nGain: 0.320831299\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"47\" [label = \"Leaf\nCover: 1\nValue: 0.365389258\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"48\" [label = \"Leaf\nCover: 32\nValue: 1.36996269\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"49\" [label = \"Leaf\nCover: 1\nValue: 0.343675822\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"50\" [label = \"Leaf\nCover: 21\nValue: 1.2736243\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"51\" [label = \"Leaf\nCover: 1\nValue: 0.228820622\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"52\" [label = \"Leaf\nCover: 64\nValue: 0.825943947\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"53\" [label = \"Tree 4\nBiologicalMaterial09\nCover: 144\nGain: 15.4052734\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"54\" [label = \"Leaf\nCover: 2\nValue: 1.08846855\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"55\" [label = \"ManufacturingProcess32\nCover: 142\nGain: 8.00976562\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"56\" [label = \"Leaf\nCover: 81\nValue: 2.66083479\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"57\" [label = \"Leaf\nCover: 61\nValue: 3.1676228\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"58\" [label = \"Tree 3\nManufacturingProcess32\nCover: 144\nGain: 6.06640625\", fillcolor = \"Beige\", shape = \"rectangle\", fontcolor = \"black\"] \n  \"59\" [label = \"Leaf\nCover: 87\nValue: 3.78576183\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n  \"60\" [label = \"Leaf\nCover: 57\nValue: 4.48674297\", fillcolor = \"Khaki\", shape = \"oval\", fontcolor = \"black\"] \n\"1\"->\"2\" [label = \"< 33.6500015\", style = \"bold\"] \n\"2\"->\"4\" [label = \"< 20.4449997\", style = \"bold\"] \n\"3\"->\"6\" [label = \"< 158.5\", style = \"bold\"] \n\"4\"->\"8\" [label = \"< 6.71500015\", style = \"bold\"] \n\"6\"->\"10\" [label = \"< 22.0449982\", style = \"bold\"] \n\"7\"->\"12\" [label = \"< 1.53499997\", style = \"bold\"] \n\"8\"->\"14\" [label = \"< 5.31000042\", style = \"bold\"] \n\"10\"->\"16\" [label = \"< 5917.5\", style = \"bold\"] \n\"13\"->\"18\" [label = \"< 52.2900009\", style = \"bold\"] \n\"15\"->\"20\" [label = \"< 6045\", style = \"bold\"] \n\"17\"->\"22\" [label = \"< 11.4499998\", style = \"bold\"] \n\"19\"->\"24\" [label = \"< 7.35000038\", style = \"bold\"] \n\"22\"->\"26\" [label = \"< 44.2450027\", style = \"bold\"] \n\"23\"->\"28\" [label = \"< 44.5699997\", style = \"bold\"] \n\"30\"->\"31\" [label = \"< 160.5\", style = \"bold\"] \n\"31\"->\"33\" [label = \"< 33.8499985\", style = \"bold\"] \n\"32\"->\"35\" [label = \"< 9.5\", style = \"bold\"] \n\"33\"->\"37\" [label = \"< 1.8499999\", style = \"bold\"] \n\"34\"->\"39\" [label = \"< 2.3499999\", style = \"bold\"] \n\"35\"->\"41\" [label = \"< 205.350006\", style = \"bold\"] \n\"38\"->\"43\" [label = \"< 0.449999988\", style = \"bold\"] \n\"40\"->\"45\" [label = \"< 12.0299997\", style = \"bold\"] \n\"42\"->\"47\" [label = \"< 52.5599976\", style = \"bold\"] \n\"44\"->\"49\" [label = \"< 45.1599998\", style = \"bold\"] \n\"46\"->\"51\" [label = \"< 9.61000061\", style = \"bold\"] \n\"53\"->\"54\" [label = \"< 12.0249996\", style = \"bold\"] \n\"55\"->\"56\" [label = \"< 158.5\", style = \"bold\"] \n\"58\"->\"59\" [label = \"< 159.5\", style = \"bold\"] \n\"1\"->\"3\" [style = \"bold\", style = \"solid\"] \n\"2\"->\"5\" [style = \"solid\", style = \"solid\"] \n\"3\"->\"7\" [style = \"solid\", style = \"solid\"] \n\"4\"->\"9\" [style = \"solid\", style = \"solid\"] \n\"6\"->\"11\" [style = \"solid\", style = \"solid\"] \n\"7\"->\"13\" [style = \"solid\", style = \"solid\"] \n\"8\"->\"15\" [style = \"solid\", style = \"solid\"] \n\"10\"->\"17\" [style = \"solid\", style = \"solid\"] \n\"13\"->\"19\" [style = \"solid\", style = \"solid\"] \n\"15\"->\"21\" [style = \"solid\", style = \"solid\"] \n\"17\"->\"23\" [style = \"solid\", style = \"solid\"] \n\"19\"->\"25\" [style = \"solid\", style = \"solid\"] \n\"22\"->\"27\" [style = \"solid\", style = \"solid\"] \n\"23\"->\"29\" [style = \"solid\", style = \"solid\"] \n\"30\"->\"32\" [style = \"solid\", style = \"solid\"] \n\"31\"->\"34\" [style = \"solid\", style = \"solid\"] \n\"32\"->\"36\" [style = \"solid\", style = \"solid\"] \n\"33\"->\"38\" [style = \"solid\", style = \"solid\"] \n\"34\"->\"40\" [style = \"solid\", style = \"solid\"] \n\"35\"->\"42\" [style = \"solid\", style = \"solid\"] \n\"38\"->\"44\" [style = \"solid\", style = \"solid\"] \n\"40\"->\"46\" [style = \"solid\", style = \"solid\"] \n\"42\"->\"48\" [style = \"solid\", style = \"solid\"] \n\"44\"->\"50\" [style = \"solid\", style = \"solid\"] \n\"46\"->\"52\" [style = \"solid\", style = \"solid\"] \n\"53\"->\"55\" [style = \"solid\", style = \"solid\"] \n\"55\"->\"57\" [style = \"solid\", style = \"solid\"] \n\"58\"->\"60\" [style = \"solid\", style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>